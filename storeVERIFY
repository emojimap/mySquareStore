<?php
$mji = array("a00"=>"ðŸ’ˆ","a01"=>"ðŸŽˆ","a02"=>"ðŸŽ‚","a03"=>"ðŸ”‘","a04"=>"ðŸˆ","a05"=>"ðŸ””","a06"=>"ðŸ‘½","a07"=>"ðŸ»","a08"=>"ðŸ©","a09"=>"ðŸ’‹","a10"=>"ðŸŒ€","a11"=>"ðŸ‘","a12"=>"ðŸ•¶","a13"=>"ðŸ˜ƒ","a14"=>"ðŸª","a15"=>"ðŸ€","a16"=>"ðŸ’‚","a17"=>"ðŸ“œ","a18"=>"ðŸª","a19"=>"ðŸº","a20"=>"ðŸ«","a21"=>"ðŸŒ¼","a22"=>"ðŸ’","a23"=>"ðŸ‡","a24"=>"ðŸ°","a25"=>"ðŸ¬","a26"=>"ðŸš©","a27"=>"ðŸ’","a28"=>"ðŸº","a29"=>"ðŸ€","a30"=>"ðŸŒ›","a31"=>"ðŸ“","a32"=>"ðŸ‘»","a33"=>"ðŸ³","a34"=>"ðŸ“˜","a35"=>"ðŸš§","a36"=>"ðŸ“€","a37"=>"ðŸŽ","a38"=>"ðŸŽ©","a39"=>"ðŸ’­","a40"=>"ðŸŽ¸","a41"=>"ðŸŒ´","a42"=>"ðŸ‰");
shuffle($mji);
$mjithx = $mji[0] . " " . $mji[1] . " " . $mji[2];
echo $mjithx;

$idem = uniqid('emoji-0001-');
$completed = '';
$cvv = '';


$secs  = 2592000;
$cents = 100;

if ($_POST["ckbx"] == 'on') {
$secs  = 15552000;
$cents = 500;
}

$time = $_SERVER['REQUEST_TIME'] + $secs;

$sid = test_input($_POST["sid"]);
$emoji = test_input($_POST["emoji"]);
$promo = test_input($_GET["promo"]);
$lalo = test_input($_POST["lalo"]);
$lalo = str_replace("+", '', $lalo);
$lalo = str_replace(" ", '', $lalo);
$lalo = explode(",",$lalo);
 try {	$code = file_get_contents("codes.txt");	} catch(Exception $e) {}

$ref=0;  if ($_SERVER['HTTP_REFERER'] == 'https://windrose.farm/store/emoji') {$ref=1;}


$params = array(
	'amount_money' => array(
	'amount' => $cents,
	'currency'  => 'USD'
),
'idempotency_key' => $idem,
'source_id' => $sid 
);

$hdr = [];
$hdr[] = 'Square-Version: 2023-04-19';
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 
$hdr[] = 'Authorization: Bearer xxxxxxxxxxxxxxxx_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx-xxxx-xxxxxxxxxxxx';
$hdr[] = 'Content-Type: application/json';

$handle = curl_init();

if (!$handle) {die("Couldn't initialize a cURL handle");}

$url = "https://connect.squareup.com/v2/payments";  

curl_setopt($handle, CURLOPT_URL, $url); 
curl_setopt($handle, CURLOPT_RETURNTRANSFER, true);  
curl_setopt($handle, CURLOPT_HTTPHEADER, $hdr);
curl_setopt($handle, CURLOPT_POSTFIELDS, json_encode($params)); 


$output =  curl_exec($handle);
curl_close($handle);
  
$output = json_decode($output,true); 
foreach ($output as $key => $value) {
	try { 
		$word = 'COMPLETED';
		$word2 = 'CVV_ACCEPTED';
		$string = print_r(array_values($value), true);
		if (strpos($string, $word) !== false) {    $completed = 'completed';	}
		if (strpos($string, $word2) !== false) {    $cvv = 'accepted';	}
		//echo $string;
		//echo $value;
		}
	catch(Exception $e) {}
}
 
if( file_exists("codes.txt") == 1 && $promo == $code && $ref=1 ){
	unlink("codes.txt");
	chdir("../");
	$db = new SQLite3('map.db') or die('Unable to open database');
	$query = "INSERT INTO map VALUES ('". $lalo[0] . "','" . $lalo[1] . "','" . $emoji . "','https://windrose.farm/game','ðŸ˜Ž Thanks! <br>" . $mjithx . "','" . $time . "','lockers');";
	$db->exec($query) or die('insert failed.');
	echo "<html><script>window.location.replace('https://windrose.farm/store/thankYou');</script>";
} elseif ($completed == 'completed' && $cvv == 'accepted' && $ref=1 ) {
	chdir("../");
	$db = new SQLite3('map.db') or die('Unable to open database');
	$query = "INSERT INTO map VALUES ('". $lalo[0] . "','" . $lalo[1] . "','" . $emoji . "','https://windrose.farm/game','ðŸ˜Ž Thanks! <br>" . $mjithx . "','" . $time . "','lockers');";
	$db->exec($query) or die(' ');
	echo "<html><script>window.location.replace('https://windrose.farm/store/thankYou');</script>";
}else {
	echo "<html><script>window.location.replace('https://windrose.farm/store/error');</script>";
}

function test_input($data) {
$data = trim($data);
$data = stripslashes($data);
$data = htmlspecialchars($data);
return $data;
}
?>

